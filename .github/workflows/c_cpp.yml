name: ghcr.io/opencyphal/c_cpp container build and publish.

on:
  release:
    types: [ published ]
    
  pull_request:
    branches: [ "main" ]

env:
  ORG_NAMESPACE: opencyphal
  IMAGE_NAME: c_cpp
  LATEST_TAG: ubuntu-20.04

jobs:

  build_and_publish:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: dryrun-build
      if: ${{ github.event_name == 'pull_request' }}
      run: docker build ./c_cpp
    - name: build-and-push
      if: ${{ github.event_name == 'release' && contains(github.ref, "20.04-c_cpp") }}
      uses: macbre/push-to-ghcr@master
      with:
        context: ./${{ env.IMAGE_NAME }}
        dockerfile: ./${{ env.IMAGE_NAME }}/Dockerfile
        image_name: ${{ env.ORG_NAMESPACE }}/${{ env.IMAGE_NAME }}
        github_token: ${{ secrets.GITHUB_TOKEN }}
        image_tag: ${{ env.LATEST_TAG }}
        repository: ghcr.io
